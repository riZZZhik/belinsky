steps:
  # Install dependencies.
  - name: python
    entrypoint: pip
    args: [ "install", "-r", "app/requirements.txt", "--user" ]

  # Run tests
  - name: python
    entrypoint: pip
    args: [ "install", "pytest==7.1.1", "blinker==1.4", "--user" ]

  - name: python
    entrypoint: python
    args: ["-m", "pytest", "-W", "ignore::DeprecationWarning"]
    env:
      - "BELINSKY_GOOGLE_CLOUD_CREDENTIALS=${_BELINSKY_GOOGLE_CLOUD_CREDENTIALS}"
      - "BELINSKY_POSTGRES_URI=${_BELINSKY_POSTGRES_URI}"

  # Docker Build
  - name: "gcr.io/cloud-builders/docker"
    args: [
      "build",
      "--target", "production",
      "-t", "europe-north1-docker.pkg.dev/${PROJECT_ID}/${_ARTIFACT_REGISTRY_REPO}/belinsky:${SHORT_SHA}",
      "app/."
    ]

  # Docker push to Google Artifact Registry
  - name: "gcr.io/cloud-builders/docker"
    args: ["push",  "europe-north1-docker.pkg.dev/${PROJECT_ID}/${_ARTIFACT_REGISTRY_REPO}/belinsky:${SHORT_SHA}"]

# Save test logs to Google Cloud Storage
artifacts:
  objects:
    location: gs://${_BUCKET_NAME}/
    paths:
      - ${SHORT_SHA}_test_log.xml

images:
  - europe-north1-docker.pkg.dev/${PROJECT_ID}/${_ARTIFACT_REGISTRY_REPO}/belinsky:${SHORT_SHA}
